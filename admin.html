<!doctype html>
<html lang="de"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin ‚Äì Teilnehmer (v2)</title>
<style>
body{font-family:Inter, Arial, sans-serif;background:#f5f5f7;margin:0;padding:20px}
.wrap{max-width:1200px;margin:auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
.tools{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.input{padding:10px;border:1px solid #ddd;border-radius:10px;min-width:260px}
.btn{padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fafafa;cursor:pointer;font-weight:800}
.btn.primary{background:#d21d1d;color:#fff;border-color:#d21d1d}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #ececec;text-align:left}
.actions{display:flex;gap:8px}
.del{background:#111;color:#fff}
.undo{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#fff3cd;color:#664d03;border:1px solid #ffe69c;padding:10px 16px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.08);display:none;gap:12px;align-items:center;z-index:1000}
.undo button{border:none;background:#ffd24d;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:800}
</style></head><body>
<div class="wrap">
  <h1>Teilnehmerverwaltung</h1>
  <div class="tools">
    <input id="search" class="input" placeholder="üîé Suche (Vorname, Nachname, Verein, TTR)">
    <button class="btn" onclick="load()">Aktualisieren</button>
    <button class="btn primary" onclick="location.href='/download'">CSV herunterladen</button>
  </div>
  <div id="content">Lade‚Ä¶</div>
</div>

<div id="undo" class="undo">
  <span>üóëÔ∏è Spieler gel√∂scht.</span>
  <button onclick="undoDelete()">R√ºckg√§ngig</button>
</div>

<script>
let allRows = [];
let lastDeleted = null;
let undoTimer = null;

async function load(){
  const r = await fetch('/api/teilnehmer',{headers:{'Accept':'application/json'}});
  if(!r.ok){document.getElementById('content').textContent='Fehler'; return;}
  allRows = await r.json();
  render();
}

function render(){
  const q = document.getElementById('search').value.trim().toLowerCase();
  let rows = allRows.filter(p => {
    const blob = `${p.vorname||''} ${p.nachname||''} ${p.verein||''} ${p.ttr||''}`.toLowerCase();
    return !q || blob.includes(q);
  });
  rows.sort((a,b) => (a.nachname||'').localeCompare(b.nachname||'', 'de', {sensitivity:'base'}));

  if(rows.length===0){ document.getElementById('content').textContent='Keine Treffer'; return; }

  const body = rows.map((p,i)=> rowHtml(p,i+1)).join('');
  document.getElementById('content').innerHTML = `<table><thead><tr><th>#</th><th>Vorname</th><th>Nachname</th><th>Geburtsdatum</th><th>TTR</th><th>Verein</th><th>Aktion</th></tr></thead><tbody>${body}</tbody></table>`;
}

function rowHtml(p,idx){
  return `<tr data-id="${escapeHtml(p.id)}">
    <td>${idx}</td>
    <td><input class="input" name="vorname" value="${escapeHtml(p.vorname)}"></td>
    <td><input class="input" name="nachname" value="${escapeHtml(p.nachname)}"></td>
    <td><input class="input" name="geburtsdatum" value="${escapeHtml(p.geburtsdatum)}"></td>
    <td><input class="input" name="ttr" value="${escapeHtml(p.ttr)}"></td>
    <td><input class="input" name="verein" value="${escapeHtml(p.verein)}"></td>
    <td class="actions">
      <button class="btn primary" onclick="saveRow(this)">üíæ Speichern</button>
      <button class="btn del" onclick="delRow(this)">üóëÔ∏è L√∂schen</button>
    </td>
  </tr>`;
}

function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c])}

async function saveRow(btn){
  const tr = btn.closest('tr');
  const id = tr.getAttribute('data-id');
  const payload = {};
  tr.querySelectorAll('input').forEach(inp => payload[inp.name] = inp.value);
  const r = await fetch('/api/teilnehmer/'+encodeURIComponent(id), {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!r.ok){ alert('Fehler beim Speichern'); return; }
  const ix = allRows.findIndex(x=>x.id===id);
  if(ix>=0) allRows[ix] = {id, ...payload};
  render();
}

async function delRow(btn){
  const tr = btn.closest('tr');
  const id = tr.getAttribute('data-id');
  const row = allRows.find(x=>x.id===id);
  lastDeleted = row ? {...row} : null;

  const r = await fetch('/api/teilnehmer/'+encodeURIComponent(id), { method:'DELETE' });
  if(!r.ok){ alert('Fehler beim L√∂schen'); return; }
  allRows = allRows.filter(x=>x.id!==id);
  render();
  showUndo();
}

function showUndo(){
  const bar = document.getElementById('undo');
  bar.style.display = 'flex';
  clearTimeout(undoTimer);
  undoTimer = setTimeout(()=>{ hideUndo(); lastDeleted = null; }, 10000);
}
function hideUndo(){
  document.getElementById('undo').style.display = 'none';
}
async function undoDelete(){
  if(!lastDeleted) return hideUndo();
  const payload = {
    vorname: lastDeleted.vorname || '',
    nachname: lastDeleted.nachname || '',
    geburtsdatum: lastDeleted.geburtsdatum || '',
    ttr: lastDeleted.ttr || '',
    verein: lastDeleted.verein || ''
  };
  await fetch('/anmelden', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  lastDeleted = null;
  hideUndo();
  load();
}

document.getElementById('search').addEventListener('input', render);
load();
</script>
</body></html>
